<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>CircuitLab ‚Äì LT‚ÄëSpice‚Äëstyle Editor</title>
<style>
/* ----- Global ------------------------------------------------- */
:root{
  --bg:#010101;        /* LT‚ÄëSpice dark background */
  --panel:#1b1b1b;     /* panel background */
  --accent:#0d8ba2;    /* toolbar blue */
  --accent2:#5f8c3e;   /* highlight green */
  --muted:#6a6a6a;     /* text */
  --fg:#f8f8f8;        /* foreground */
}
*{box-sizing:border-box;margin:0;padding:0;user-select:none;}
html,body{height:100%;font-family:Consolas,monospace;background:var(--bg);color:var(--fg);overflow:hidden;}
a{color:inherit;text-decoration:none;}
/* ----- Layout ------------------------------------------------- */
.app{
  display:grid;grid-template-columns:240px 1fr 260px;grid-template-rows:48px 1fr;gap:4px;
  height:100%;padding:4px;
}
header{grid-column:1/-1;background:var(--panel);border-radius:6px;display:flex;align-items:center;gap:8px;padding:4px;}
header h1{font-size:14px;font-weight:bold;flex:1;}
.toolbar{display:flex;gap:4px;align-items:center;}
.btn{background:var(--accent);color:var(--fg);padding:4px 8px;border-radius:4px;font-size:12px;cursor:pointer;}
.btn:hover{background:var(--accent2);}
.btn:disabled{background:var(--muted);cursor:not-allowed;}
.left.panel{background:var(--panel);border-radius:6px;padding:8px;overflow:auto;}
.right.panel{background:var(--panel);border-radius:6px;padding:8px;display:flex;flex-direction:column;gap:4px;}
.canvas-wrap{background:var(--panel);border-radius:6px;overflow:hidden;position:relative;}
#canvas{width:100%;height:100%;cursor:crosshair;background:linear-gradient(90deg,#0e0e0e,#202020);display:block;}
.palette .item{background:rgba(255,255,255,.02);padding:6px;border-radius:4px;cursor:grab;display:flex;align-items:center;gap:6px;margin-bottom:4px;}
.palette .item:hover{background:rgba(255,255,255,.06);}
.log{background:rgba(255,255,255,.01);padding:4px;border-radius:4px;font-size:11px;overflow:auto;height:70px;}
.net-label{font-size:10px;padding:2px 4px;border-radius:4px;background:rgba(16,185,129,.12);color:var(--accent2);margin-bottom:2px;}
#graph{flex:1;border:1px solid var(--muted);border-radius:4px;}
/* ----- SVG --------------------------------------------------- */
.wire{stroke:#9fb6ff;stroke-width:4;stroke-linecap:round;stroke-linejoin:round;fill:none;}
.handle{fill:var(--accent);cursor:pointer;}
.grid-line{stroke:rgba(255,255,255,.05);stroke-width:1;}
.voltage-text{font-size:10px;fill:#fff;stroke:#000;stroke-width:.5px;}
/* ----- Misc ----------------------------------------------- */
.small{font-size:10px;color:var(--muted);}
</style>
</head>
<body>
<div class="app">
  <!-- Header / toolbar -->
  <header>
    <h1>CircuitLab ‚Äì LT‚ÄëSpice‚Äëstyle</h1>
    <div class="toolbar">
      <button id="newBtn" class="btn">New</button>
      <button id="openBtn" class="btn">Open</button>
      <button id="saveBtn" class="btn">Save</button>
      <div class="small">Simulate:</div>
      <select id="simSelect" class="btn"><option value="dc">DC Sweep</option></select>
      <button id="runSim" class="btn">Run</button>
      <button id="exportJson" class="btn">Export JSON</button>
      <button id="exportSvg" class="btn">Export SVG</button>
      <label class="small" style="margin-left:8px">Grid</label>
      <input id="gridToggle" type="checkbox" checked />
    </div>
  </header>

  <!-- Left palette -->
  <aside class="left panel">
    <div class="palette">
      <div class="item" draggable="true" data-type="wire">üîó Wire</div>
      <div class="item" draggable="true" data-type="resistor">Œ© Resistor</div>
      <div class="item" draggable="true" data-type="vsource">üîã V Source</div>
      <div class="item" draggable="true" data-type="ground">‚èö Ground</div>
      <hr/>
      <div style="display:flex;gap:6px;margin-top:6px">
        <button id="toolSelect" class="btn">Select</button>
        <button id="toolWire" class="btn">Draw Wire</button>
      </div>
      <small class="small">Draw Wire: click start ‚Üí click end. Snaps to grid.</small>
    </div>
  </aside>

  <!-- Canvas -->
  <main class="canvas-wrap panel">
    <svg id="canvas" viewBox="0 0 1600 900"></svg>
  </main>

  <!-- Right panel -->
  <aside class="right panel">
    <div id="netList"><strong>Node Voltages</strong></div>
    <div id="graph"><strong>Waveform</strong></div>
    <div id="log" class="log"><strong>Log</strong></div>
  </aside>
</div>

<script>
/* ---------- State & Undo/Redo ------------------------------ */
let state = { components: [], wires: [], nextId: 1, selection: null };
let undoStack=[], redoStack=[];
function snapshotPush(){ undoStack.push(JSON.stringify(state)); if(undoStack.length>200) undoStack.shift(); redoStack=[]; updateUndoButtons(); }
function updateUndoButtons(){ document.getElementById('undoBtn').disabled=undoStack.length===0; document.getElementById('redoBtn').disabled=redoStack.length===0; }
function undo(){ if(!undoStack.length)return; redoStack.push(JSON.stringify(state)); state=JSON.parse(undoStack.pop()); render(); logMsg('Undo'); }
function redo(){ if(!redoStack.length)return; undoStack.push(JSON.stringify(state)); state=JSON.parse(redoStack.pop()); render(); logMsg('Redo'); }

/* ---------- Helpers ---------------------------------------- */
let draggingPoint=null, dragWire=null;
const GRID=16;
function snap(v){ return Math.round(v/GRID)*GRID; }
function svgPoint(x,y){ const svg=document.getElementById('canvas'); const pt=svg.createSVGPoint(); pt.x=x; pt.y=y; return pt.matrixTransform(svg.getScreenCTM().inverse()); }
function logMsg(m){ const d=document.createElement('div'); d.textContent=m; document.getElementById('log').prepend(d); }
function uid(){ return (state.nextId++).toString(); }

function getAllTerminals(){ const t=[]; state.components.forEach(c=>c.points.forEach(p=>t.push({x:p.x,y:p.y}))); state.wires.forEach(w=>w.points.forEach(p=>t.push({x:p.x,y:p.y}))); return t; }
function snapToTerminal(pt){ const d=12; for(const t of getAllTerminals()){ const dx=pt.x-t.x, dy=pt.y-t.y; if(Math.hypot(dx,dy)<d)return {x:t.x,y:t.y}; } return pt; }

function createOrthogonalPoints(x1,y1,x2,y2){
  const dx=Math.abs(x2-x1), dy=Math.abs(y2-y1);
  return (dx>=dy) ? [{x:x1,y:y1},{x:x2,y:y1},{x:x2,y:y2}] : [{x:x1,y:y1},{x:x1,y:y2},{x:x2,y:y2}];
}

/* ---------- Adding components ------------------------------ */
function addComponent(type,x,y){
  snapshotPush(); const id=uid();
  if(type==='wire'){
    const pts=createOrthogonalPoints(x,y,x+80,y);
    state.wires.push({id,points:pts});
  }else{
    const comp={id,type,x,y,value:(type==='resistor'?1000:(type==='vsource'?5:0)),points:[{x:x-28,y},{x:x+28,y}]};
    if(type==='ground')comp.value=0;
    state.components.push(comp);
  }
  render();
}

/* ---------- Rendering -------------------------------------- */
function render(){
  const svg=document.getElementById('canvas'); while(svg.firstChild)svg.removeChild(svg.firstChild);
  // defs
  const defs=document.createElementNS('http://www.w3.org/2000/svg','defs');
  defs.innerHTML='<marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#10b981"/></marker>';
  svg.appendChild(defs);
  // grid
  const gridOn=document.getElementById('gridToggle').checked;
  if(gridOn){
    const w=1600,h=900;
    for(let x=0;x<=w;x+=GRID){ const l=document.createElementNS('http://www.w3.org/2000/svg','line'); l.setAttribute('x1',x); l.setAttribute('y1',0); l.setAttribute('x2',x); l.setAttribute('y2',h); l.setAttribute('class','grid-line'); svg.appendChild(l);}
    for(let y=0;y<=h;y+=GRID){ const l=document.createElementNS('http://www.w3.org/2000/svg','line'); l.setAttribute('x1',0); l.setAttribute('y1',y); l.setAttribute('x2',w); l.setAttribute('y2',y); l.setAttribute('class','grid-line'); svg.appendChild(l);}
  }
  // components & wires
  renderComponents(svg); renderWires(svg); computeAndShowNets(svg); drawPreview();
}

/* ---------- Wires ------------------------------------------ */
function renderWires(svg){
  state.wires.forEach(w=>{
    const poly=document.createElementNS('http://www.w3.org/2000/svg','polyline');
    poly.setAttribute('points',w.points.map(p=>`${p.x},${p.y}`).join(' '));
    poly.setAttribute('class','wire'); svg.appendChild(poly);
    // handles
    w.points.forEach((p,i)=>{
      const h=document.createElementNS('http://www.w3.org/2000/svg','circle');
      h.setAttribute('cx',p.x); h.setAttribute('cy',p.y); h.setAttribute('r',5); h.setAttribute('class','handle');
      h.addEventListener('mousedown',e=>{ draggingPoint=p; dragWire=w; e.stopPropagation(); });
      h.addEventListener('dblclick',e=>{ snapshotPush(); w.points.splice(i+1,0,{x:p.x+GRID*1.5,y:p.y}); render(); });
      svg.appendChild(h);
    });
  });
}

/* ---------- Components ------------------------------------- */
function renderComponents(svg){
  state.components.forEach(c=>{
    const g=document.createElementNS('http://www.w3.org/2000/svg','g');
    g.setAttribute('transform',`translate(${c.x},${c.y})`);
    g.setAttribute('class','component'); g.dataset.id=c.id;
    // common symbol
    if(c.type==='resistor'){
      const pts=[[-28,0],[-20,-10],[-12,10],[-4,-10],[4,10],[12,-10],[20,0]];
      const poly=document.createElementNS('http://www.w3.org/2000/svg','polyline');
      poly.setAttribute('points',pts.map(p=>p.join(',')).join(' '));
      poly.setAttribute('stroke','#dfefff');poly.setAttribute('stroke-width','2');poly.setAttribute('fill','none');
      g.appendChild(poly);
      const txt=document.createElementNS('http://www.w3.org/2000/svg','text');
      txt.setAttribute('x',0); txt.setAttribute('y',-14); txt.setAttribute('text-anchor','middle'); txt.setAttribute('fill','#dfefff'); txt.textContent=`${c.value}Œ©`;
      g.appendChild(txt);
    }else if(c.type==='vsource'){
      const txt=document.createElementNS('http://www.w3.org/2000/svg','text');
      txt.setAttribute('x',0); txt.setAttribute('y',22); txt.setAttribute('text-anchor','middle'); txt.setAttribute('fill','#dfefff'); txt.textContent=`${c.value}V`;
      g.appendChild(txt);
      const lineL=document.createElementNS('http://www.w3.org/2000/svg','line');
      lineL.setAttribute('x1',-10); lineL.setAttribute('y1',-12); lineL.setAttribute('x2',-10); lineL.setAttribute('y2',12);
      lineL.setAttribute('stroke','#dfefff'); lineL.setAttribute('stroke-width','2');
      g.appendChild(lineL);
      const lineS=document.createElementNS('http://www.w3.org/2000/svg','line');
      lineS.setAttribute('x1',10); lineS.setAttribute('y1',-6); lineS.setAttribute('x2',10); lineS.setAttribute('y2',6);
      lineS.setAttribute('stroke','#dfefff'); lineS.setAttribute('stroke-width','2');
      g.appendChild(lineS);
    }else if(c.type==='ground'){
      const l1=document.createElementNS('http://www.w3.org/2000/svg','line'); l1.setAttribute('x1',0); l1.setAttribute('y1',0); l1.setAttribute('x2',0); l1.setAttribute('y2',8);
      l1.setAttribute('stroke','#dfefff'); g.appendChild(l1);
      const l2=document.createElementNS('http://www.w3.org/2000/svg','line'); l2.setAttribute('x1',-8); l2.setAttribute('y1',8); l2.setAttribute('x2',8); l2.setAttribute('y2',8);
      l2.setAttribute('stroke','#dfefff'); g.appendChild(l2);
      const l3=document.createElementNS('http://www.w3.org/2000/svg','line'); l3.setAttribute('x1',-5); l3.setAttribute('y1',10); l3.setAttribute('x2',5); l3.setAttribute('y2',10);
      l3.setAttribute('stroke','#dfefff'); g.appendChild(l3);
    }
    // selection & edit
    g.addEventListener('mousedown',e=>{ e.stopPropagation(); state.selection={id:c.id,type:c.type}; document.getElementById('selValue').value=c.value; });
    g.addEventListener('dblclick',e=>{ e.stopPropagation(); const v=prompt('Value:',c.value); if(v!==null){ snapshotPush(); c.value=parseFloat(v)||c.value; render(); }});
    svg.appendChild(g);
  });
}

/* ---------- Mouse Interaction ----------------------------- */
document.addEventListener('mousemove',e=>{
  if(draggingPoint){
    const pt=svgPoint(e.clientX,e.clientY);
    const gridOn=document.getElementById('gridToggle').checked;
    const newPt=gridOn?{x:snap(pt.x),y:snap(pt.y)}:snapToTerminal(pt);
    draggingPoint.x=newPt.x; draggingPoint.y=newPt.y;
    render();
  }else if(currentTool==='draw-wire' && preview.active){
    const pt=svgPoint(e.clientX,e.clientY);
    const gridOn=document.getElementById('gridToggle').checked;
    const newPt=gridOn?{x:snap(pt.x),y:snap(pt.y)}:snapToTerminal(pt);
    preview.end=newPt; drawPreview();
  }
});
document.addEventListener('mouseup',()=>{ draggingPoint=null; dragWire=null; });

/* ---------- Wire drawing tool ----------------------------- */
let currentTool='select';
document.getElementById('toolSelect').addEventListener('click',()=>{ currentTool='select'; logMsg('Tool: select'); });
document.getElementById('toolWire').addEventListener('click',()=>{ currentTool='draw-wire'; logMsg('Tool: draw wire'); });

let preview={active:false,start:null,end:null};
const svgCanvas=document.getElementById('canvas');
svgCanvas.addEventListener('mousedown',e=>{
  const pt=svgPoint(e.clientX,e.clientY);
  const gridOn=document.getElementById('gridToggle').checked;
  const snapped=gridOn?{x:snap(pt.x),y:snap(pt.y)}:snapToTerminal(pt);
  if(currentTool==='draw-wire'){
    if(!preview.active){
      preview.active=true; preview.start=snapped; preview.end=snapped;
      drawPreview();
    }else{
      snapshotPush();
      const pts=createOrthogonalPoints(preview.start.x,preview.start.y,preview.end.x,preview.end.y);
      state.wires.push({id:uid(),points:pts});
      preview.active=false; preview.start=null; preview.end=null;
      render();
    }
  }
});

/* ---------- Preview ---------------------------------------- */
function drawPreview(){
  render(); // full redraw, then overlay
  if(!preview.active)return;
  const svg=document.getElementById('canvas');
  const pts=createOrthogonalPoints(preview.start.x,preview.start.y,preview.end.x,preview.end.y);
  const poly=document.createElementNS('http://www.w3.org/2000/svg','polyline');
  poly.setAttribute('points',pts.map(p=>`${p.x},${p.y}`).join(' '));
  poly.setAttribute('class','wire'); poly.setAttribute('stroke','#7fb2ff'); poly.setAttribute('stroke-width','3'); poly.setAttribute('stroke-dasharray','6 4');
  svg.appendChild(poly);
}

/* ---------- DC Solver ------------------------------------- */
function computeAndShowNets(svg){
  const map=new Map(); let nodeCnt=1;
  function key(p){return `${p.x},${p.y}`;}
  function getNode(p){ const k=key(p); if(map.has(k))return map.get(k); const n=(p.isGround?0:nodeCnt++); map.set(k,n); return n; }
  // assign node numbers
  state.components.forEach(c=>{
    c.points.forEach(p=>{ if(c.type==='ground'){p.isGround=true;}});
    c.nodes=c.points.map(getNode);
  });
  state.wires.forEach(w=>{
    w.points.forEach(p=>{ if(!p.isGround){p.isGround=false;}});
    w.nodes=w.points.map(getNode);
  });
  // merge wire ends
  state.wires.forEach(w=>{
    const n0=w.nodes[0], n1=w.nodes[w.nodes.length-1];
    if(n0!==n1){
      map.forEach((v,k)=>{ if(v===n1) map.set(k,n0); });
    }
  });
  // unique nodes
  const uniq=[...new Set([...map.values()])];
  const idx={}; uniq.forEach((n,i)=>idx[n]=i);
  const N=uniq.length;
  const Vsrcs=state.components.filter(c=>c.type==='vsource');
  const size=N+Vsrcs.length;
  const M=Array.from({length:size},()=>Array(size).fill(0));
  const RHS=Array(size).fill(0);
  const getIdx=(n)=>idx.hasOwnProperty(n)?idx[n]:0;
  // resistors
  state.components.filter(c=>c.type==='resistor').forEach(c=>{
    const n1=getIdx(c.nodes[0]), n2=getIdx(c.nodes[1]), g=1/c.value;
    if(n1!==0)M[n1][n1]+=g; if(n2!==0)M[n2][n2]+=g;
    if(n1!==0&&n2!==0){M[n1][n2]-=g; M[n2][n1]-=g;}
  });
  // voltage sources
  Vsrcs.forEach((v,i)=>{
    const row=N+i; const n1=getIdx(v.nodes[0]), n2=getIdx(v.nodes[1]);
    if(n1!==0){M[row][n1]=1; M[n1][row]=1;}
    if(n2!==0){M[row][n2]=-1; M[n2][row]=-1;}
    RHS[row]=v.value;
  });
  // solve by Gaussian elimination
  const solve=(A,b)=>{
    const n=A.length; const B=A.map((r,i)=>[...r,b[i]]);
    for(let i=0;i<n;i++){
      // pivot
      let p=i; for(let k=i+1;k<n;k++) if(Math.abs(B[k][i])>Math.abs(B[p][i])) p=k;
      if(p!==i) [B[i],B[p]]=[B[p],B[i]];
      const pivot=B[i][i]||1e-12;
      for(let k=i+1;k<n;k++){
        const f=B[k][i]/pivot;
        for(let j=i;j<=n;j++) B[k][j]-=f*B[i][j];
      }
    }
    const x=Array(n).fill(0);
    for(let i=n-1;i>=0;i--){
      let s=B[i][n];
      for(let j=i+1;j<n;j++) s-=B[i][j]*x[j];
      x[i]=s/B[i][i];
    }
    return x;
  };
  const sol=solve(M,RHS);
  const nodeV=sol.slice(0,N);
  const vSrcI=sol.slice(N);
  // display node voltages
  const netList=document.getElementById('netList'); netList.innerHTML='<strong>Node Voltages</strong>';
  uniq.forEach((node,i)=>{ const div=document.createElement('div'); div.className='net-label'; div.textContent=`Node ${node}: ${nodeV[i].toFixed(3)} V`; netList.appendChild(div); });
  // plot simple waveform on right panel
  const graph=document.getElementById('graph'); graph.innerHTML='<strong>Waveform</strong>';
  const width=graph.clientWidth, height=graph.clientHeight;
  const canvas=document.createElement('canvas'); canvas.width=width; canvas.height=height; graph.appendChild(canvas);
  const ctx=canvas.getContext('2d');
  ctx.fillStyle='#000'; ctx.fillRect(0,0,width,height);
  if(Vsrcs.length>0){
    const data=Vsrcs[0].value; // treat DC as static waveform
    ctx.strokeStyle='#0d8ba2'; ctx.lineWidth=2;
    ctx.beginPath();
    const step=width/(data.length-1||1);
    data.forEach((v,i)=>{ const x=i*step; const y=height/2-(v-height/2)*0.8; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);});
    ctx.stroke();
  }
  // show wire arrow colours (optional)
  // (kept from original: draw arrows with thickness and colour)
  /* ... (same arrow‚Äëdrawing code as before) ... */
}

/* ---------- Toolbar actions -------------------------------- */
document.getElementById('applyValue').addEventListener('click',()=>{
  if(!state.selection)return;
  const c=state.components.find(x=>x.id===state.selection.id);
  if(c){ snapshotPush(); c.value=parseFloat(document.getElementById('selValue').value)||c.value; render(); }
});
document.getElementById('deleteSel').addEventListener('click',()=>{
  if(!state.selection)return;
  snapshotPush();
  state.components=state.components.filter(x=>x.id!==state.selection.id);
  state.wires=state.wires.filter(x=>x.id!==state.selection.id);
  state.selection=null; render();
});
document.getElementById('runSim').addEventListener('click',()=>{
  computeAndShowNets(document.getElementById('canvas')); logMsg('DC simulation complete');
});
document.getElementById('undoBtn').addEventListener('click',undo);
document.getElementById('redoBtn').addEventListener('click',redo);

/* ---------- Export ---------------------------------------- */
document.getElementById('exportJson').addEventListener('click',()=>{
  const data=JSON.stringify(state,null,2);
  const blob=new Blob([data],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='circuit.json'; a.click(); URL.revokeObjectURL(url);
  logMsg('Exported JSON');
});
document.getElementById('exportSvg').addEventListener('click',()=>{
  const svg=document.getElementById('canvas').cloneNode(true);
  const s=new XMLSerializer().serializeToString(svg);
  const blob=new Blob([s],{type:'image/svg+xml;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='circuit.svg'; a.click(); URL.revokeObjectURL(url);
  logMsg('Exported SVG');
});

/* ---------- Drag‚Äëdrop palette -------------------------------- */
document.querySelectorAll('.palette .item').forEach(it=>it.addEventListener('dragstart',e=>e.dataTransfer.setData('text/plain',it.dataset.type)));
svgCanvas.addEventListener('dragover',e=>e.preventDefault());
svgCanvas.addEventListener('drop',e=>{
  e.preventDefault();
  const type=e.dataTransfer.getData('text/plain');
  const pt=svgPoint(e.clientX,e.clientY);
  const gridOn=document.getElementById('gridToggle').checked;
  const snapped=gridOn?{x:snap(pt.x),y:snap(pt.y)}:snapToTerminal(pt);
  addComponent(type,snapped.x,snapped.y);
});

/* ---------- Demo content ----------------------------------- */
addComponent('vsource',220,160);
addComponent('resistor',420,160);
addComponent('ground',620,160);
snapshotPush();
updateUndoButtons();
</script>
</body>
</html>
